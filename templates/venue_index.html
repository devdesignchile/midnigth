{% extends "base.html" %}
{% load static %}

{% block title %}
Carreteo — {{ active_city|default:"Todas las ciudades" }}
{% endblock %}

{% block content %}
<!-- ========= HERO CIUDAD ========= -->
<section class="py-5 text-center">
  <h1 class="display-1  mb-5">Adonde ir</h1>
  <p class="text-soft mb-4" id="city-counter">
    {% if city %}
      {{ city.name }} · {{ venues_count }} lugares
    {% else %}
      .
    {% endif %}
  </p>

  <form id="city-filter-form" class="container" method="get" autocomplete="off">
    <!-- fila 1: input grande de ciudad -->
    <div class="row justify-content-center mb-3">
      <div class="col-12 col-lg-8">
        <div class="position-relative">
          <input
            id="city-input"
            class="form-control form-control-lg rounded-pill px-4 py-3"
            type="text"
            name="city"
            value="{{ active_city_label|default:city_input_value }}"
            placeholder="Escribe una ciudad"
            aria-autocomplete="list"
            aria-expanded="false"
            aria-owns="city-suggestions"
            role="combobox"
          >
          <!-- panel de sugerencias -->
          <div
            id="city-suggestions"
            class="list-group shadow position-absolute w-100 mt-2 d-none"
            style="max-height: 260px; overflow:auto; z-index: 1050;"
          ></div>
        </div>
      </div>
    </div>

    <!-- fila 2: fecha y categoría -->
    <div class="row justify-content-center g-3">
      <div class="col-12 col-md-3">
        <label class="form-label small">Fecha</label>
        <select class="form-select rounded-pill" name="when">
          <option value="cualquier_dia" {% if active_when == "cualquier_dia" %}selected{% endif %}>Cualquier día</option>
          <option value="hoy" {% if active_when == "hoy" %}selected{% endif %}>Hoy</option>
          <option value="esta_semana" {% if active_when == "esta_semana" %}selected{% endif %}>Esta semana</option>
        </select>
      </div>

      <div class="col-12 col-md-3">
        <label class="form-label small">¿Qué buscas?</label>
        <select class="form-select rounded-pill" name="cat">
          <option value="">Todo</option>
          <option value="discoteque" {% if active_cat == "discoteque" %}selected{% endif %}>Discoteques</option>
          <option value="pub" {% if active_cat == "pub" %}selected{% endif %}>Pubs</option>
          <option value="restaurant" {% if active_cat == "restaurant" %}selected{% endif %}>Restaurantes</option>
          <option value="rooftop" {% if active_cat == "rooftop" %}selected{% endif %}>Rooftops</option>
          <option value="other" {% if active_cat == "other" %}selected{% endif %}>Otros</option>
        </select>
      </div>

      <div class="col-12 col-md-2 d-grid">
        <label class="form-label opacity-0">.</label>
        <button class="btn btn-brand rounded-pill" type="submit">Buscar</button>
      </div>
    </div>

    {% if q %}
      <input type="hidden" name="q" value="{{ q }}">
    {% endif %}
  </form>
</section>

<!-- ========= CONTENIDO ========= -->
<main class="py-4 my-5" id="lugares">
  <div class="container">

    <!-- NAV DE CATEGORÍAS
    <div class="bg-surface-1 rounded-lg p-2 shadow-1 mb-3">
      <ul class="nav nav-pills overflow-auto flex-nowrap gap-2" role="tablist" style="--bs-nav-link-padding-x: .25rem;">
        {% with cat=active_cat %}
          <li class="nav-item">
            <a class="btn btn-ghost btn-pill {% if not cat %}active{% endif %}" href="{{ cat_urls.all }}">Todos</a>
          </li>
          <li class="nav-item">
            <a class="btn btn-ghost btn-pill {% if cat == 'pub' %}active{% endif %}" href="{{ cat_urls.pub }}">Pubs/Bares</a>
          </li>
          <li class="nav-item">
            <a class="btn btn-ghost btn-pill {% if cat == 'restaurant' %}active{% endif %}" href="{{ cat_urls.restaurant }}">Restaurantes</a>
          </li>
          <li class="nav-item">
            <a class="btn btn-ghost btn-pill {% if cat == 'rooftop' %}active{% endif %}" href="{{ cat_urls.rooftop }}">Rooftops</a>
          </li>
          <li class="nav-item">
            <a class="btn btn-ghost btn-pill {% if cat == 'discoteque' %}active{% endif %}" href="{{ cat_urls.discoteque }}">Discoteques</a>
          </li>
        {% endwith %}
      </ul>
    </div> -->

    <!-- WRAPPER DINÁMICO -->
    <div id="dynamic-sections" data-json-endpoint="{% url 'city_index_json' %}">

      {% if city and featured_venues %}
      <!-- LUGARES DESTACADOS -->
      <section class="container my-5">
        <h2 class="h3 display-6 mb-5">Lugares destacados en {{ city.name }}</h2>
        <div id="featured-venues" class="row g-3">
          {% for v in featured_venues %}
            {% with hero=v.cover_image %}
              <div class="col-6 col-md-4 col-lg-3">
                <a href="{% url 'venue-detail' slug=v.slug %}" class="text-decoration-none card-hero shadow-sm">
                  <div class="card-hero__img">
                    {% if hero %}
                      <img src="{{ hero.url }}" alt="{{ v.name }}" class="object-fit-cover">
                    {% else %}
                      <img src="{% static 'img/placeholders/venue-cover.jpg' %}" alt="{{ v.name }}" class="object-fit-cover">
                    {% endif %}
                    <div class="card-hero__overlay"></div>
                    <div class="card-hero__meta">
                      <span class="badge bg-primary text-capitalize">{{ v.get_category_display }}</span>
                      <h3>{{ v.name }}</h3>
                      <div class="small">{{ v.Commune.name }}</div>
                    </div>
                  </div>
                </a>
              </div>
            {% endwith %}
          {% endfor %}
        </div>
      </section>
      {% endif %}

      <!-- GRID DE LUGARES -->
      <section class="container">
        <div id="venues-grid" class="row g-3">
          {% for v in venues %}
            <div class="col-12 col-md-6 col-lg-4">
              <a class="card card-event text-decoration-none h-100" href="{% url 'venue-detail' slug=v.slug %}">
                <div class="card-cover">
                  {% if v.cover_image %}
                    <img src="{{ v.cover_image.url }}" alt="{{ v.name }}">
                  {% else %}
                    <img src="{% static 'img/placeholders/venue-cover.jpg' %}" alt="{{ v.name }}">
                  {% endif %}
                </div>
                <div class="card-body">
                  <h4 class="h6 mb-1 text-white">{{ v.name }}</h4>
                  <div class="small text-soft">
                    {{ v.get_category_display }}{% if v.Commune %} · {{ v.Commune.name }}{% endif %}
                  </div>
                  {% if v.hours_short %}
                    <div class="small text-soft mt-1">{{ v.hours_short }}</div>
                  {% endif %}
                  {% if v.vibe_tags.all %}
                    <div class="mt-2 d-flex flex-wrap gap-1">
                      {% for t in v.vibe_tags.all|slice:":3" %}
                        <span class="badge rounded-pill text-bg-dark">{{ t.name }}</span>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              </a>
            </div>
          {% empty %}
            <div class="col-12">
              <div class="alert alert-secondary mb-0">
                No hay lugares publicados en {{ active_city_label|default:"todas las ciudades" }} todavía.
              </div>
            </div>
          {% endfor %}
        </div>
      </section>
    </div>
  </div>
</main>

<!-- ====== Autocomplete ciudades (sin mapa) ====== -->
<!-- Fuente JSON (desde la vista) — si no la tienes aún, hay fallback -->
<script id="city-names-json" type="application/json">{{ city_names_json|safe }}</script>
<script id="cities-fallback-json" type="application/json">[]</script>

<script>
(function() {
  const form  = document.getElementById('city-filter-form');
  const input = document.getElementById('city-input');
  const panel = document.getElementById('city-suggestions');
  if (!form || !input || !panel) return;

  function parseJSONById(id){
    try { const el = document.getElementById(id); return el && el.textContent ? JSON.parse(el.textContent) : []; }
    catch(e){ return []; }
  }

  const citiesList = parseJSONById('city-names-json').length ? parseJSONById('city-names-json') : parseJSONById('cities-fallback-json');

  const norm = s => (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
  const debounce = (fn, ms=120) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

  let currentIndex = -1;
  const show = () => { panel.classList.remove('d-none'); input.setAttribute('aria-expanded','true'); };
  const hide = () => { panel.classList.add('d-none'); input.setAttribute('aria-expanded','false'); currentIndex = -1; };

  function createItem(name, term){
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'list-group-item list-group-item-action';
    btn.setAttribute('role','option');
    if (!term) btn.textContent = name;
    else {
      const n = norm(name), t = norm(term); const i = n.indexOf(t);
      if (i < 0) btn.textContent = name;
      else {
        btn.append(document.createTextNode(name.slice(0,i)));
        const strong = document.createElement('strong'); strong.textContent = name.slice(i, i+term.length);
        btn.append(strong, document.createTextNode(name.slice(i+term.length)));
      }
    }
    btn.addEventListener('click', ()=>{ input.value = name; hide(); form.submit(); });
    return btn;
  }

  function rankedFilter(q){
    const t = norm(q); if(!t) return citiesList.slice(0,12);
    const starts = [], contains = [];
    for (const c of citiesList){
      const nc = norm(c);
      if (nc.startsWith(t)) starts.push(c);
      else if (nc.includes(t)) contains.push(c);
    }
    return [...starts, ...contains];
  }

  function render(list, term){
    panel.innerHTML = '';
    if (!list.length){
      const empty = document.createElement('div'); empty.className = 'list-group-item text-muted'; empty.textContent = 'Sin resultados';
      panel.append(empty); show(); return;
    }
    list.slice(0,10).forEach(n => panel.append(createItem(n, term)));
    show();
  }

  const onType = debounce(v => render(rankedFilter(v), v), 120);
  input.addEventListener('input', e => onType(e.target.value));
  input.addEventListener('focus', () => onType(input.value));
  input.addEventListener('keydown', (e) => {
    const items = Array.from(panel.querySelectorAll('.list-group-item-action')); if (!items.length) return;
    if (e.key === 'ArrowDown'){ e.preventDefault(); currentIndex = (currentIndex+1)%items.length; items.forEach(i=>i.classList.remove('active')); items[currentIndex].classList.add('active'); items[currentIndex].scrollIntoView({block:'nearest'}); }
    else if (e.key === 'ArrowUp'){ e.preventDefault(); currentIndex = (currentIndex-1+items.length)%items.length; items.forEach(i=>i.classList.remove('active')); items[currentIndex].classList.add('active'); items[currentIndex].scrollIntoView({block:'nearest'}); }
    else if (e.key === 'Enter'){ if (currentIndex >= 0){ e.preventDefault(); items[currentIndex].click(); } }
    else if (e.key === 'Escape'){ hide(); }
  });
  document.addEventListener('click', (e)=>{ if (!panel.contains(e.target) && e.target !== input) hide(); });
})();
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const nav = document.querySelector(".nav.nav-pills");
  if (!nav) return;

  nav.addEventListener("click", async e => {
    const link = e.target.closest("a[href]");
    if (!link) return;
    e.preventDefault();

    // Activa visualmente el botón
    nav.querySelectorAll(".btn-pill").forEach(b => b.classList.remove("active"));
    link.classList.add("active");

    // Muestra loading
    const featured = document.querySelector("#featured-venues");
    const grid = document.querySelector("#venues-grid");
    featured && (featured.innerHTML = "<div class='text-center p-5 text-soft'>Cargando...</div>");
    grid && (grid.innerHTML = "<div class='text-center p-5 text-soft'>Cargando...</div>");

    try {
      const url = new URL("{% url 'city_index_json' %}", window.location.origin);
      // copiar los parámetros de la URL del link
      const query = link.href.split("?")[1];
      if (query) url.search = query;

      const res = await fetch(url);
      const data = await res.json();

      if (data.featured) featured.innerHTML = data.featured;
      if (data.grid) grid.innerHTML = data.grid;
    } catch (err) {
      console.error(err);
      if (grid) grid.innerHTML = "<div class='alert alert-danger'>Error al cargar los datos.</div>";
    }
  });
});
</script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const wrap = document.getElementById("featured-cities-container");
  if (!wrap) return;

  const needs = wrap.dataset.needsCity === "1";
  if (!needs) return; // si ya hay ciudad buscada, no cargamos destacados

  const endpoint = wrap.dataset.endpoint;
  try {
    wrap.innerHTML = "<div class='text-center p-5 text-soft'>Cargando ciudades…</div>";
    const res = await fetch(endpoint, { headers: { "X-Requested-With": "XMLHttpRequest" } });
    const data = await res.json();
    wrap.innerHTML = data.html || "";
  } catch (e) {
    console.error(e);
    wrap.innerHTML = "<div class='alert alert-danger'>No se pudieron cargar las ciudades destacadas.</div>";
  }
});
</script>

{% endblock %}
