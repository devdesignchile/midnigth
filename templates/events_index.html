{% extends "base.html" %}
{% load static %}

{# ====== SEO ESPECÍFICO PARA LA PÁGINA DE EVENTOS ====== #}
{% block title %}Eventos hoy en {{ active_city_label|default:"Chile" }} | Midnight{% endblock %}

{% block meta_description %}
Descubre eventos hoy en {{ active_city_label|default:"Chile" }}: fiestas, conciertos, stand up, electrónica, reggaetón y más. Filtra por comuna, explora eventos destacados, de hoy, próximos 7 días y de este mes con Midnight.
{% endblock %}

{# Open Graph / Twitter específicos #}
{% block og_title %}Eventos hoy en {{ active_city_label|default:"Chile" }} | Midnight{% endblock %}
{% block og_description %}
Explora los mejores eventos en {{ active_city_label|default:"Chile" }}: fiestas, shows y panoramas nocturnos organizados por fecha y relevancia. Encuentra tu próximo carrete con Midnight.
{% endblock %}
{% block twitter_title %}Eventos hoy en {{ active_city_label|default:"Chile" }} | Midnight{% endblock %}
{% block twitter_description %}
Encuentra eventos destacados, de hoy, próximos 7 días y de este mes en {{ active_city_label|default:"Chile" }}. Filtra por comuna y estilo con Midnight.
{% endblock %}

{# Schema extra: CollectionPage orientada a eventos #}
{% block meta_schema %}
  {{ block.super }}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "name": "Eventos en {{ active_city_label|default:"Chile" }}",
    "description": "Listado de eventos nocturnos organizados por fecha en {{ active_city_label|default:"Chile" }}: fiestas, conciertos, stand up, música electrónica y más.",
    "inLanguage": "es",
    "about": [
      "eventos nocturnos",
      "fiestas",
      "conciertos",
      "bares",
      "discoteques"
    ],
    "isPartOf": {
      "@type": "WebSite",
      "name": "Midnight"
    }
  }
  </script>
{% endblock %}

{% block content %}
<!-- =========================
     HERO con búsqueda + autocompletado comunas
     ========================= -->
<header class="hero py-5 py-lg-6 section-with-bg"
        style="--section-bg: url('{% static 'img/header-events.jpg' %}');">
  <div class="container py-4">
    <div class="row justify-content-center text-center g-4">
      <div class="col-12 col-lg-9 mx-auto">
        <p class="tagline mb-1 text-uppercase small opacity-75">Explora tu ciudad</p>
        <h1 class="display-1 mb-4">
          Eventos hoy{% if active_city_label %} en {{ active_city_label }}{% endif %}
        </h1>
        <p class="lead mb-5">
          Encuentra fiestas, conciertos, stand up y eventos especiales en tu ciudad. 
          Busca por nombre, estilo musical o filtra por comuna para decidir dónde salir hoy.
        </p>

        <!-- Panel de búsqueda minimal -->
        <div class="search-shell mx-auto">
          <form action="." method="get" class="row g-2 align-items-stretch" role="search" aria-label="Buscar eventos por nombre y comuna">
            <!-- Texto libre -->
            <div class="col-12 col-lg-7">
              <label for="q" class="visually-hidden">Buscar evento o venue</label>
              <div class="input-group h-100">
                <span class="input-group-text"><i class="bi bi-search" aria-hidden="true"></i></span>
                <input id="q" name="q" type="search" class="form-control ring-focus"
                       placeholder="Busca un evento o venue… (ej: reggaetón, jazz, stand up)"
                       value="{{ q }}" autocomplete="off">
              </div>
            </div>

            <!-- Comuna con datalist -->
            <div class="col-12 col-lg-3">
              <label for="cityInput" class="visually-hidden">Comuna</label>
              <input id="cityInput"
                    list="communesList"
                    class="form-control h-100 ring-focus"
                    placeholder="Comuna"
                    value="{{ active_city_label }}" autocomplete="off">

              <input type="hidden"
                    id="citySlugHidden"
                    name="city"
                    value="{{ active_city }}">
                    
              <datalist id="communesList"></datalist>

            </div>

            <!-- Botón -->
            <div class="col-12 col-lg-2 d-grid">
              <button type="submit" class="btn btn-brand h-100">
                Buscar
              </button>
            </div>
          </form>

          <!-- Tips mini (opcionales) -->
          <div class="mini-hints">
            <span><i class="bi bi-magic" aria-hidden="true"></i> Ej: “reggaetón”, “jazz”, “stand up”</span>
            <span>•</span>
            <span><i class="bi bi-geo-alt" aria-hidden="true"></i> Filtra por comuna desde el campo “Comuna”</span>
          </div>
        </div>

        <span id="city-current" class="visually-hidden">{{ active_city_label }}</span>
      </div>
    </div>
  </div>
</header>

{% if communes_json %}
<script id="communes-data" type="application/json">{{ communes_json|safe }}</script>
{% endif %}

<style>
/* ====== Minimal / Glass look del buscador ====== */
.search-shell{
  max-width: 960px;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  background: rgba(15, 16, 28, 0.35);
  border: 1px solid rgba(255,255,255,0.08);
  box-shadow: 0 10px 30px rgba(0,0,0,0.25);
  border-radius: 20px;
  padding: 16px;
}
.search-shell .input-group-text{
  background: transparent;
  border-right: 0;
}
.search-shell .form-control{
  border-left: 0;
}
.search-shell .form-control,
.search-shell .input-group-text{
  border-color: rgba(255,255,255,0.12);
  color: #fff;
  background: rgba(255,255,255,0.04);
}
.search-shell .form-control::placeholder{ color: rgba(255,255,255,0.6); }
.search-shell .btn-brand{
  border-radius: 14px;
}
.ring-focus:focus{
  outline: none;
  box-shadow: 0 0 0 0.2rem rgba(99,102,241,.35); /* acorde a --brand-500 */
  border-color: transparent;
}
.mini-hints{
  display:flex; gap:.5rem; justify-content:center; align-items:center;
  color: rgba(255,255,255,.75); font-size:.875rem; margin-top:.75rem;
}
.hero .tagline{ letter-spacing:.08em; }
</style>

<!-- =========================
     RESUMEN
     ========================= -->
<section class="container py-4" aria-labelledby="events-summary-heading">
  <header class="d-flex justify-content-between align-items-end mb-3">
    <div>
      <h2 id="events-summary-heading" class="h4 mb-1">
        Eventos en {{ active_city_label|default:"Chile" }}
      </h2>
      <small class="text-soft">
        {{ total }} resultados 
        (filtrados por {% if active_cat %}categoría{% elif q %}búsqueda{% else %}fecha y comuna{% endif %})
      </small>
    </div>
    <!-- botón filtros móvil opcional -->
    <button class="btn btn-ghost d-lg-none" data-bs-toggle="offcanvas" data-bs-target="#filtersCanvas">
      <i class="bi bi-sliders" aria-hidden="true"></i> Filtros
    </button>
  </header>
</section>

<!-- =========================
     SECCIONES (máx. 16 c/u) pobladas por JS
     ========================= -->
<section class="container pb-2" aria-label="Secciones de eventos por fecha y relevancia">
  <!-- Publicitados 
  <div class="mb-4">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h3 class="h5 mb-0">Eventos Destacados</h3>
    </div>
    <div class="row g-3" id="sec-promoted"></div>
  </div> -->

  <!-- Hoy -->
  <div class="mb-4">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h3 class="h5 mb-0">Eventos de Hoy</h3>
    </div>
    <div class="row g-3" id="sec-today"></div>
  </div>

  <!-- Próximos 7 días -->
  <div class="mb-4">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h3 class="h5 mb-0">Eventos Próximos 7 días</h3>
    </div>
    <div class="row g-3" id="sec-next7"></div>
  </div>

  <!-- Este mes -->
  <div class="mb-1">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h3 class="h5 mb-0">Eventos de este mes</h3>
    </div>
    <div class="row g-3" id="sec-month"></div>
  </div>
</section>

<!-- =========================
     FUENTE ÚNICA DE CARDS (servidor) -> JS las reparte
     ========================= -->
<section class="container pb-4" aria-label="Listado paginado de eventos">
  <div class="alert alert-secondary small">
    <i class="bi bi-info-circle" aria-hidden="true"></i>
    Mostrando la página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }} 
    (la distribución en secciones usa solo los eventos de esta página).
  </div>

  <!-- Contenedor "fuente" (oculto) -->
  <div class="row g-3 d-none" id="source-cards">
    {% for e in events %}
      <div class="col-12 col-sm-6 col-lg-3">
        <a href="{{ e.cta_url }}"
           class="event-card text-decoration-none d-block h-100"
           {% if e.cta_is_external %}target="_blank" rel="noopener"{% endif %}
           data-bs-toggle="tooltip" data-bs-title="Ver detalle del evento"
           data-start="{{ e.start_at|date:'c' }}"
           data-month="{{ e.start_at|date:'Y-m' }}"
           data-promoted="{{ e.is_promoted|yesno:'1,0' }}">
          <div class="card event-card__wrap bg-surface-1 border-0 overflow-hidden position-relative shadow-1 rounded-3 h-100">
            <!-- Imagen -->
            <div class="event-card__media ratio ratio-16x9">
              {% if e.flyer_image %}
                <img src="{{ e.flyer_image.url }}" alt="Flyer del evento {{ e.title }}" class="w-100 h-100 object-fit-cover">
              {% else %}
                <img src="{% static 'img/placeholders/venue-cover.jpg' %}" alt="Evento {{ e.title }}" class="w-100 h-100 object-fit-cover">
              {% endif %}
            </div>

            <!-- Degradado -->
            <div class="event-card__gradient"></div>

            <div class="card-body position-absolute bottom-0 start-0 end-0">
              {% if e.badge_text %}
                <span class="badge text-bg-primary mb-2">{{ e.badge_text }}</span>
              {% endif %}
              <h3 class="h6 mb-1 text-white">{{ e.title }}</h3>
              <div class="small text-soft mb-0">
                {{ e.start_at|date:"D d M · H:i" }}
                {% if e.venue %} · {{ e.venue.name }}{% endif %}
              </div>
            </div>

            <!-- Overlay -->
            <div class="event-overlay">
              <div class="overlay-content text-center">
                <h4 class="h6 fw-semibold mb-1 text-white">{{ e.title }}</h4>
                <p class="small mb-2">
                  {{ e.start_at|date:"D d M · H:i" }}
                  {% if e.venue and e.venue.commune %}
                    · {{ e.venue.commune.name }}
                  {% endif %}
                </p>
                {% if e.get_category_display %}
                  <span class="badge text-bg-dark">{{ e.get_category_display }}</span>
                {% endif %}
              </div>
            </div>
          </div>
        </a>
      </div>
    {% empty %}
      <div class="col-12">
        <div class="alert alert-secondary">No hay eventos próximos.</div>
      </div>
    {% endfor %}
  </div>

  <!-- paginación -->
  {% if is_paginated %}
  <nav class="mt-4" aria-label="Paginación de eventos">
    <ul class="pagination justify-content-center">
      {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}">Anterior</a>
        </li>
      {% endif %}
      <li class="page-item disabled">
        <span class="page-link">Página {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
      </li>
      {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode|cut:'page='|cut:'&page=' }}">Siguiente</a>
        </li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</section>

<!-- =========================
     MODAL Quick View (opcional)
     ========================= -->
<div class="modal fade" id="quickView" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-surface-1">
      <div class="modal-header">
        <h5 class="modal-title">Vista rápida del evento</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <img class="w-100 rounded-md" src="{% static 'img/placeholders/venue-cover.jpg' %}" alt="Imagen del evento seleccionado">
          </div>
          <div class="col-12 col-md-6">
            <h6 class="mb-1">Nombre del evento</h6>
            <p class="text-soft small mb-2">Vie 08 Nov · 23:00 · Club X</p>
            <p class="mb-3">Descripción corta del evento para enriquecer la decisión del usuario.</p>
            <div class="d-flex gap-2">
              <a href="#" class="btn btn-brand"><i class="bi bi-ticket-perforated" aria-hidden="true"></i> Comprar</a>
              <button class="btn btn-ghost" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer small text-soft">
        * La información puede cambiar sin previo aviso.
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
// --- Autocompletado comunas desde communes_json (sin mostrar slug) ---
let communes = [];
try {
  const raw = document.getElementById("communes-data")?.textContent || "[]";
  communes = JSON.parse(raw);
} catch (e) {
  communes = [];
}

const dl = document.getElementById("communesList");
const cityInput = document.getElementById("cityInput");

// Asegura hidden (el que realmente se envía como ?city=slug)
let hidden = document.getElementById("citySlugHidden");
if (!hidden && cityInput?.form) {
  hidden = document.createElement("input");
  hidden.type = "hidden";
  hidden.name = "city";           // ESTE es el que viaja al backend
  hidden.id = "citySlugHidden";
  cityInput.form.appendChild(hidden);
}

// 1) Render del datalist: SOLO nombre visible, slug guardado en data-attribute
if (Array.isArray(communes) && dl) {
  dl.innerHTML = "";
  communes.forEach(c => {
    if (!c) return;

    const name = (c.name || "").trim();
    const slug = (c.slug || "").trim();

    if (!name) return;

    const opt = document.createElement("option");
    opt.value = name;            // lo que ve el usuario (La Serena)
    opt.dataset.slug = slug;     // lo que guardamos sin mostrar (la-serena)
    dl.appendChild(opt);
  });
}

// helper: sincroniza el hidden según lo que está escrito/seleccionado
function syncCitySlug() {
  if (!dl || !hidden || !cityInput) return;

  const typed = (cityInput.value || "").trim().toLowerCase();
  const match = [...dl.options].find(o => (o.value || "").trim().toLowerCase() === typed);

  hidden.value = match ? (match.dataset.slug || "") : "";
}

// 2) Cuando el usuario selecciona o escribe, actualiza el slug
cityInput?.addEventListener("input", syncCitySlug);
cityInput?.addEventListener("change", syncCitySlug);

// 3) Al cargar, por si el input viene precargado con “La Serena”
syncCitySlug();


  // --- Tooltips Bootstrap ---
  [...document.querySelectorAll('[data-bs-toggle="tooltip"]')]
    .forEach(el => new bootstrap.Tooltip(el));

  // --- Distribución en secciones (máx. 16 por sección) ---
  const source = document.getElementById("source-cards");
  const promotedWrap = document.getElementById("sec-promoted");
  const todayWrap    = document.getElementById("sec-today");
  const next7Wrap    = document.getElementById("sec-next7");
  const monthWrap    = document.getElementById("sec-month");

  if (!source) return;

  const cards = [...source.querySelectorAll(".col-12")]; // columnas fuente
  const now = new Date();
  const startToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const endToday   = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1);
  const end7       = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 8); // incluye hoy + 7 completos
  const monthEnd   = new Date(now.getFullYear(), now.getMonth() + 1, 1);

  let cProm=0, cToday=0, cNext7=0, cMonth=0;

  function within(d, a, b){ return d >= a && d < b; }

  cards.forEach(col => {
    const a = col.querySelector("a.event-card");
    if (!a) return;

    const startISO = a.getAttribute("data-start");
    const d = startISO ? new Date(startISO) : null;
    const promoted = a.getAttribute("data-promoted") === "1";

    // 1) Publicitados
    if (promoted && cProm < 16) {
      promotedWrap?.appendChild(col.cloneNode(true));
      cProm++;
      return; // no repetir en otras secciones
    }

    if (!d || isNaN(d.getTime())) return;

    // 2) Hoy
    if (cToday < 16 && within(d, startToday, endToday)) {
      todayWrap?.appendChild(col.cloneNode(true));
      cToday++;
      return;
    }

    // 3) Próximos 7 días (excluye hoy)
    if (cNext7 < 16 && d >= endToday && d < end7) {
      next7Wrap?.appendChild(col.cloneNode(true));
      cNext7++;
      return;
    }

    // 4) Este mes (resto del mes excluyendo lo ya tomado)
    if (cMonth < 16 && d >= end7 && d < monthEnd) {
      monthWrap?.appendChild(col.cloneNode(true));
      cMonth++;
      return;
    }
  });

  function ensureNotEmpty(wrap) {
    if (wrap && wrap.children.length === 0) {
      const div = document.createElement("div");
      div.className = "col-12";
      div.innerHTML = '<div class="alert alert-secondary">No hay elementos para esta sección.</div>';
      wrap.appendChild(div);
    }
  }
  ensureNotEmpty(promotedWrap);
  ensureNotEmpty(todayWrap);
  ensureNotEmpty(next7Wrap);
  ensureNotEmpty(monthWrap);
});
</script>

<!-- Toast feedback -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="actionToast" class="toast bg-surface-1 text-white border-0 shadow-2" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-body small">
      <i class="bi bi-check2-circle me-2" aria-hidden="true"></i>Filtros aplicados correctamente.
    </div>
  </div>
</div>
{% endblock %}
