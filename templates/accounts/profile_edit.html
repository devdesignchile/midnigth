{% extends "base.html" %}
{% load static %}

{% block title %}Editar perfil{% endblock %}

{% block content %}
<section class="py-5">
  <div class="container">

    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-4">
      <div>
        <h1 class="h3 fw-bold mb-1">Editar perfil</h1>
        <p class="text-soft mb-0">Personaliza tu cuenta. Cambios guardados al instante ✨</p>
      </div>
      <a href="javascript:history.back()" class="btn btn-ghost btn-pill floaty d-none d-md-inline-flex">
        <i class="bi bi-arrow-left me-2"></i> Volver
      </a>
    </div>

    <!-- ⬇️ Form envuelve ambas columnas -->
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="profile-shell row g-4">

        <!-- Columna izquierda: identidad / avatar -->
        <div class="col-12 col-lg-4">
          <div class="card panel glass p-3 p-md-4">
            <div class="d-flex align-items-center gap-3">
              <div class="avatar-xl">
                {% if is_guest and form.instance.foto_personal %}
                  <img id="avatarPreview" src="{{ form.instance.foto_personal.url }}" alt="Avatar">
                {% else %}
                  <img id="avatarPreview" src="{% static 'img/placeholders/avatar.png' %}" alt="Avatar">
                {% endif %}
              </div>
              <div class="flex-fill">
                <div class="fw-bold">{{ request.user.username }}</div>
                <div class="small text-soft">
                  {% if is_owner %}Dueño de local{% else %}Asistente{% endif %}
                </div>

                {% if is_guest %}
                  <label class="btn btn-ghost btn-sm mt-2 floaty" for="id_foto_personal">
                    <i class="bi bi-camera me-1"></i> Cambiar foto
                  </label>
                {% endif %}
              </div>
            </div>

            {% if is_guest %}
            <div class="mt-3">
              <!-- AHORA DENTRO DEL FORM ✅ -->
              {{ form.foto_personal }}
              {% if form.foto_personal.errors %}
                <div class="text-danger small mt-2">{{ form.foto_personal.errors|join:", " }}</div>
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Columna derecha: campos -->
        <div class="col-12 col-lg-8">
          <div class="card panel glass p-3 p-md-4">

            <!-- OWNER -->
            {% if is_owner %}
            <div class="mb-4">
              <div class="eyebrow mb-1">Negocio</div>
              <h2 class="h5 fw-bold mb-0">Datos del local</h2>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nombre del local</label>
                {{ form.venue_name }}
                {% if form.venue_name.errors %}<div class="invalid-hint">{{ form.venue_name.errors|join:", " }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">Administrador</label>
                {{ form.admin_name }}
                {% if form.admin_name.errors %}<div class="invalid-hint">{{ form.admin_name.errors|join:", " }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">RUT comercio</label>
                {{ form.rut_comercio }}
                {% if form.rut_comercio.errors %}<div class="invalid-hint">{{ form.rut_comercio.errors|join:", " }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">Correo corporativo</label>
                {{ form.company_email }}
                {% if form.company_email.errors %}<div class="invalid-hint">{{ form.company_email.errors|join:", " }}</div>{% endif %}
              </div>
              <div class="col-md-12">
                <label class="form-label">Dominio comercial</label>
                {{ form.company_domain }}
                {% if form.company_domain.errors %}<div class="invalid-hint">{{ form.company_domain.errors|join:", " }}</div>{% endif %}
              </div>
            </div>
            {% endif %}

            <!-- GUEST -->
            {% if is_guest %}
            <div class="mb-4">
              <div class="eyebrow mb-1">Tu cuenta</div>
              <h2 class="h5 fw-bold mb-0">Información personal</h2>
            </div>

            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Nombre</label>
                {{ form.first_name }}
                {% if form.first_name.errors %}<div class="invalid-hint">{{ form.first_name.errors|join:", " }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">Apellido</label>
                {{ form.last_name }}
                {% if form.last_name.errors %}<div class="invalid-hint">{{ form.last_name.errors|join:", " }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">Fecha de nacimiento</label>
                {{ form.birth_date }}
                {% if form.birth_date.errors %}<div class="invalid-hint">{{ form.birth_date.errors|join:", " }}</div>{% endif %}
              </div>
              <div class="col-md-6">
                <label class="form-label">Ciudad</label>
                {{ form.city }}
                <datalist id="cities">
                  {% for c in cities %}<option value="{{ c }}">{% endfor %}
                </datalist>
                {% if form.city.errors %}<div class="invalid-hint">{{ form.city.errors|join:", " }}</div>{% endif %}
              </div>
            </div>
            {% endif %}

            <div class="mt-4 d-flex gap-2">
              <button class="btn btn-brand btn-pill px-4 floaty" type="submit">
                <i class="bi bi-check2 me-2"></i> Guardar cambios
              </button>
              <a href="javascript:history.back()" class="btn btn-ghost btn-pill">Cancelar</a>
            </div>

          </div>
        </div>
      </div>
    </form>
    <!-- ⬆️ Fin del form -->

    <!-- Zona de peligro -->
    <div class="card panel glass p-3 p-md-4 mt-4 border-danger" id="danger-zone">
      <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
        <div>
          <div class="eyebrow mb-1">Zona de peligro</div>
          <h3 class="h6 fw-bold mb-1 text-danger">Eliminar cuenta y cancelar suscripción</h3>
          <p class="text-soft small mb-0">
            Esto <b>cancelará</b> tu suscripción en Mercado Pago y <b>eliminará tu cuenta</b> y datos asociados. Esta acción es irreversible.
          </p>
        </div>
        <div>
          <!-- Botón que abre un modal de confirmación -->
          <button class="btn btn-outline-danger btn-pill" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal">
            <i class="bi bi-trash3 me-1"></i> Eliminar mi cuenta
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de confirmación -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4">
          <div class="modal-header border-0">
            <h5 class="modal-title">Confirmar eliminación</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <p class="mb-2">¿Seguro que deseas eliminar tu cuenta?</p>
            <ul class="small text-soft mb-0">
              <li>Se cancelará la suscripción recurrente en Mercado Pago.</li>
              <li>Se eliminarán tus datos y no podrás recuperarlos.</li>
            </ul>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-ghost btn-pill" data-bs-dismiss="modal">Volver</button>
            <form method="post" action="{% url 'account_delete' %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger btn-pill">
                Sí, eliminar y cancelar
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

<style>
.panel.glass{
  background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
  border: 1px solid rgba(255,255,255,.08);
  border-radius: var(--radius-lg, 1rem);
  backdrop-filter: blur(8px) saturate(120%);
}
.eyebrow{ letter-spacing:.12em; text-transform:uppercase; font-size:.78rem; color:var(--text-2); }
.invalid-hint{ color:#ff7a7a; font-size:.85rem; margin-top:.25rem; }
.avatar-xl{ width:88px; height:88px; border-radius:50%; overflow:hidden; flex:0 0 auto; border:1px solid rgba(255,255,255,.12); background:var(--surface-2); }
.avatar-xl img{ width:100%; height:100%; object-fit:cover; display:block; }
.form-label{ font-weight:600; color:var(--text-1); }
.btn-pill{ border-radius:999px; }
.floaty{ transition:transform .15s ease, box-shadow .15s ease; }
.floaty:hover{ transform:translateY(-1px); box-shadow:0 10px 26px rgba(0,0,0,.28); }
#id_foto_personal{ position:absolute; width:1px; height:1px; opacity:0; pointer-events:none; }
.border-danger{ border-color: rgba(220,53,69,.4) !important; }
.text-soft{ color: var(--text-2, rgba(255,255,255,.7)); }
</style>

<script>
document.addEventListener("DOMContentLoaded", function(){
  const file = document.getElementById("id_foto_personal");
  const preview = document.getElementById("avatarPreview");
  if(file && preview){
    file.addEventListener("change", (e) => {
      const [img] = e.target.files || [];
      if(img){
        const url = URL.createObjectURL(img);
        preview.src = url;
      }
    });
  }
});
</script>
{% endblock %}
