{% extends "base.html" %}
{% load static %}
{% block content %}


<!-- Hero con imagen de fondo -->
<header class="hero py-5 vh-50 py-lg-6 section-with-bg"
        style="--section-bg: url('https://images.unsplash.com/photo-1514525253161-7a46d19cd819?q=80&w=1600&auto=format&fit=crop');">
  <div class="container py-4">
    <div class="row justify-content-center text-center g-4">
      <div class="col-12 col-lg-8 mx-auto">

        <!-- Logo Midnight -->
        <img src="{% static 'img/logo-sf.png' %}" 
             alt="Midnight Logo"
             class="hero-logo mb-4">

        <h1 class="display-5 fw-extrabold hero-title mb-3">
          Descubre d√≥nde salir <span class="text-primary">hoy</span>
        </h1>

        <!-- Panel de filtros centrado -->
        <div class="p-3 p-md-4 rounded-lg shadow-1 mx-auto" style="max-width: 900px;">
          <form action="{% url 'venue_search' %}" method="get" class="row g-2 justify-content-center">
            <div class="col-12 col-md-6">
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input id="q" name="q" type="search" class="form-control ring-focus"
                       placeholder="Buscar bar, club, evento‚Ä¶">
              </div>
            </div>
            <div class="col-12 col-md-2 d-grid">
              <button type="submit" class="btn btn-brand">
                <i class="bi bi-search"></i> Buscar
              </button>
            </div>
          </form>
        </div>

        <span id="city-current" class="visually-hidden">{{ active_city_label }}</span>
      </div>
    </div>
  </div>
</header>


{# Exporta trending_items UNA sola vez, fuera del header #}
{{ trending_items|json_script:"trending-data" }}


<script>
document.addEventListener("DOMContentLoaded", () => {
  const dataNode = document.getElementById("trending-data");
  if (!dataNode) return;

  // M√°ximo 4 (por si acaso)
  const allItems = (JSON.parse(dataNode.textContent || "[]") || []).slice(0, 4);

  const cityEl = document.getElementById("trend-city");
  if (cityEl) cityEl.textContent = "{{ active_city_label }}";

  let activeTag = "all";
  const chips = document.querySelectorAll("#trendChips [data-tag]");
  chips.forEach(btn => {
    btn.addEventListener("click", () => {
      chips.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      activeTag = btn.dataset.tag;
      render();
    });
  });

  const inner = document.getElementById("trendCarouselInner");
  const indicators = document.getElementById("trendIndicators");

  function render(){
    const items = activeTag === "all"
      ? allItems
      : allItems.filter(x => (x.tags || []).includes(activeTag));

    inner.innerHTML = "";
    indicators.innerHTML = "";

    // Una sola slide con hasta 4 cards
    const slides = [items];

    slides.forEach((chunk, idx) => {
      const slide = document.createElement("div");
      slide.className = `carousel-item${idx === 0 ? " active" : ""}`;

      const grid = document.createElement("div");
      grid.className = "grid p-1";
      slide.appendChild(grid);

      chunk.forEach(card => {
        const el = document.createElement("div");
        el.className = "card-trend";

        const externalAttrs = card.external ? ' target="_blank" rel="noopener"' : '';

        el.innerHTML = `
          <a class="text-decoration-none" href="${card.href}"${externalAttrs}>
            <div class="cover position-relative">
              ${card.img ? `<img src="${card.img}" alt="${card.title}">` : ""}
              <span class="badge badge-soft position-absolute m-2">${card.badge ?? ""}</span>
            </div>
            <div class="body">
              <div class="title">${card.title}</div>
              <div class="meta">${card.venue}${card.time ? " ¬∑ " + card.time : ""}</div>
            </div>
          </a>`;
        grid.appendChild(el);
      });

      inner.appendChild(slide);

      const dot = document.createElement("button");
      dot.type = "button";
      dot.setAttribute("data-bs-target", "#trendCarousel4");
      dot.setAttribute("data-bs-slide-to", String(idx));
      if (idx === 0) dot.classList.add("active");
      indicators.appendChild(dot);
    });
  }

  render();
});
</script>


<!-- ============== Trending de hoy (Carrusel 4x) ============== -->
<!-- ============== Trending de hoy (Carrusel 4x) ============== -->
<section id="trending" class="py-5">
  <div class="container">
    <div class="d-flex flex-wrap align-items-end justify-content-between mb-3">
      <div>
        <h2 class="h3 fw-bold mb-1">Trending de hoy</h2>
        <p class="text-secondary mb-0">
          Lo m√°s visto y guardado ahora en
          <span id="trend-city">{{ active_city_label }}</span>.
        </p>
      </div>
    </div>

    <!-- Chips (opcional; filtran por tags si tus eventos tienen "tags") -->
    <div id="trendChips" class="d-flex flex-wrap gap-2 mb-4">
      <button class="btn btn-sm btn-outline-secondary active" data-tag="all">Todo</button>
      <button class="btn btn-sm btn-outline-secondary" data-tag="techno">Techno</button>
      <button class="btn btn-sm btn-outline-secondary" data-tag="reggaeton">Reggaet√≥n</button>
      <button class="btn btn-sm btn-outline-secondary" data-tag="rooftop">Rooftop</button>
      <button class="btn btn-sm btn-outline-secondary" data-tag="standup">Stand-up</button>
      <button class="btn btn-sm btn-outline-secondary" data-tag="2x1">2√ó1</button>
      <button class="btn btn-sm btn-outline-secondary" data-tag="gratis">Gratis</button>
    </div>

    <!-- Carrusel -->
    <div id="trendCarousel4" class="carousel slide" data-bs-interval="false">
      <div class="carousel-inner" id="trendCarouselInner"></div>

      <button class="carousel-control-prev" type="button" data-bs-target="#trendCarousel4" data-bs-slide="prev" aria-label="Anterior">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#trendCarousel4" data-bs-slide="next" aria-label="Siguiente">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
      </button>

      <div class="carousel-indicators mt-3 position-static" id="trendIndicators"></div>
    </div>
  </div>
</section>

{# üëá Inserta aqu√≠ el JSON seguro con los eventos ya filtrados por ciudad (hasta 4) #}
{{ trending_items|json_script:"trending-data" }}


<!-- ====== Estilos suaves para las cards (no futuristas) ====== -->

<!-- ============== JS: render din√°mico (4 por slide) ============== -->
<script>
(() => {
  const $$ = (s,c=document)=>[...c.querySelectorAll(s)];
  const $  = (s,c=document)=>c.querySelector(s);

  // Fuente de datos (ejemplo). type: 'evento' | 'lugar'
  const items = [
    {title:'Rooftop Electro', type:'evento',  tags:['rooftop','techno'], time:'Hoy 23:00', venue:'Centro', href:'/entradas/rooftop-electro', cta:'Entradas', badge:'Hoy 23:00', badgeVariant:'primary', img:'https://images.unsplash.com/photo-1532635241-17e820acc59f?q=80&w=1200&auto=format&fit=crop'},
    {title:'Bar Urbano ‚Äî 2√ó1', type:'lugar', tags:['reggaeton','2x1'],    time:'Hasta 00:00', venue:'Av. Principal', href:'#', cta:'Canjear', badge:'2√ó1', badgeVariant:'warning', img:'https://images.unsplash.com/photo-1521017432531-fbd92d05cbe6?q=80&w=1200&auto=format&fit=crop'},
    {title:'Open Mic Stand-up', type:'evento', tags:['standup','gratis'],  time:'Hoy 21:30', venue:'Teatro Centro', href:'/evento/open-mic', cta:'M√°s info', badge:'Gratis', badgeVariant:'success', img:'https://images.unsplash.com/photo-1488998527040-85054a85150e?q=80&w=1200&auto=format&fit=crop'},
    {title:'La Azotea',        type:'lugar', tags:['rooftop','2x1'],       time:'2√ó1 19‚Äì22', venue:'Mirador LS', href:'#', cta:'Canjear', badge:'Rooftop', badgeVariant:'info', img:'https://images.unsplash.com/photo-1504805572947-34fad45aed93?q=80&w=1200&auto=format&fit=crop'},
    {title:'Tech Sessions',    type:'evento', tags:['techno'],             time:'DJ invitado', venue:'Club Prisma', href:'/entradas/tech-sessions', cta:'Entradas', badge:'DJ', badgeVariant:'secondary', img:'https://images.unsplash.com/photo-1519671482749-fd09be7ccebf?q=80&w=1200&auto=format&fit=crop'},
    {title:'Flow House',       type:'lugar', tags:['reggaeton'],           time:'Nueva pista', venue:'Barrio Centro', href:'#', cta:'Guardar', badge:'Nuevo', badgeVariant:'danger', img:'https://images.unsplash.com/photo-1514525253161-7a46d19cd819?q=80&w=1200&auto=format&fit=crop'},
    {title:'Stand-up & Friends',type:'evento', tags:['standup','gratis'],  time:'Entrada gratis', venue:'Espacio Cultural', href:'/evento/standup-friends', cta:'M√°s info', badge:'Free', badgeVariant:'success', img:'https://images.unsplash.com/photo-1519751138087-5a3a3f54a3b1?q=80&w=1200&auto=format&fit=crop'},
    {title:'Sky Bar',          type:'lugar', tags:['rooftop','reggaeton'], time:'Vista 360¬∞', venue:'Costa LS', href:'#', cta:'Ver en mapa', badge:'Vista 360¬∞', badgeVariant:'info', img:'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?q=80&w=1200&auto=format&fit=crop'},
    {title:'Bassment',         type:'evento', tags:['techno'],             time:'Live set', venue:'Subsuelo BCN', href:'/entradas/bassment', cta:'Entradas', badge:'Live', badgeVariant:'dark', img:'https://images.unsplash.com/photo-1511108690759-009324a90311?q=80&w=1200&auto=format&fit=crop'}
  ];

  const $inner = $('#trendCarouselInner');
  const $indis = $('#trendIndicators');
  const perSlide = 4; // 4 por slide en desktop (se adapta con CSS a 2/1)

  function cardTemplate(it){
    return `
    <article class="card-trend h-100">
      <div class="cover">
        <img src="${it.img}" alt="${it.title}">
        <span class="position-absolute top-0 start-0 m-2 badge badge-soft">${it.type==='evento' ? 'Evento' : 'Lugar'}</span>
        <span class="position-absolute top-0 end-0 m-2 badge text-bg-${it.badgeVariant}">${it.badge}</span>
      </div>
      <div class="body">
        <h3 class="title">${it.title}</h3>
        <p class="meta mb-3"><i class="bi bi-geo"></i> ${it.venue} ‚Ä¢ ${it.time}</p>
        <div class="d-flex gap-2">
          <a href="${it.href}" class="btn btn-sm btn-primary btn-pill">${it.cta}</a>
          <button class="btn btn-sm btn-outline-secondary btn-pill"><i class="bi bi-heart"></i></button>
        </div>
      </div>
    </article>`;
  }

  function renderSlides(tag='all'){
    // filtra por chip
    const filtered = items.filter(it => tag==='all' ? true : it.tags.includes(tag));
    // construir slides de a 4
    $inner.innerHTML = '';
    $indis.innerHTML = '';
    if(!filtered.length){
      $inner.innerHTML = `<div class="carousel-item active"><div class="grid"><div class="text-center text-secondary py-5">Sin resultados para ‚Äú${tag}‚Äù.</div></div></div>`;
      return;
    }
    const chunks = [];
    for(let i=0; i<filtered.length; i+=perSlide){ chunks.push(filtered.slice(i, i+perSlide)); }

    chunks.forEach((group, idx)=>{
      const cards = group.map(cardTemplate).join('');
      const itemHTML = `
        <div class="carousel-item ${idx===0?'active':''}">
          <div class="grid">${cards}</div>
        </div>`;
      $inner.insertAdjacentHTML('beforeend', itemHTML);
      $indis.insertAdjacentHTML('beforeend',
        `<button type="button" data-bs-target="#trendCarousel4" data-bs-slide-to="${idx}" ${idx===0?'class="active" aria-current="true"':''} aria-label="Slide ${idx+1}"></button>`);
    });
  }

  // Chips
  $$('#trendChips [data-tag]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('#trendChips [data-tag]').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      renderSlides(btn.dataset.tag);
      // reset carousel a slide 0
      const car = bootstrap.Carousel.getOrCreateInstance('#trendCarousel4');
      car.to(0);
    });
  });

  // Ciudad (si tu app ya la tiene)
  const city = document.getElementById('city-current')?.textContent?.trim() || 'La Serena';
  const trendCityEl = document.getElementById('trend-city');
  if(trendCityEl) trendCityEl.textContent = city;

  // Init
  renderSlides('all');
})();
</script>


<!-- ===================== Pr√≥ximos eventos destacados (SEO) ===================== -->
<section id="destacados" class="py-5 bg-surface-1 my-5 rounded-lg container shadow-1">
  <header class="mb-4 text-center">
    <h2 class="section-title mb-1">
      Visita los lugares destacados en 
      <span id="seo-city">
        {{ active_city_label }}
      </span>
    </h2>
    <p class="section-sub mb-0">
      Agenda curada con los eventos con m√°s interacciones, rese√±as y b√∫squedas recientes.
    </p>
  </header>

<!-- Grid -->
<div id="gridDestacados" class="row g-4">
  {% if featured_venues %}
    {% for v in featured_venues %}
      <div class="col-12 col-md-6 col-lg-4 d-item"
           data-range="hoy"
           data-interacciones="{{ v.clicks_count|default:0 }}"  {# cambiado: antes v.interactions #}
           data-fecha="{{ v.updated_at|date:'Y-m-d' }}"
           data-rating="{{ v.rating|default:'4.5' }}">
        <article class="card-event position-relative h-100">

          {# ===== Enlace que dispara el tracking ===== #}
          <a class="stretched-link text-decoration-none"
             href="{% url 'venue-detail' slug=v.slug %}"
             aria-label="{{ v.name }}"
             data-track-model="venue"                         {# nuevo #}
             data-track-id="{{ v.id }}">                      {# nuevo #}
          </a>

          <div class="card-cover">
            {% if v.cover_image %}
              <img src="{{ v.cover_image.url }}" alt="{{ v.name }}" loading="lazy">
            {% elif v.gallery_venue %}
              <img src="{{ v.gallery_venue.url }}" alt="{{ v.name }}" loading="lazy">
            {% else %}
              <img src="{% static 'img/placeholders/venue-cover.jpg' %}" alt="{{ v.name }}" loading="lazy">
            {% endif %}

            {# Badges superiores #}
            <span class="position-absolute top-0 start-0 m-2 badge text-bg-warning">
              {{ v.get_category_display|default:"Lugar" }}
            </span>
            {% if v.is_advertised|default_if_none:False or v.is_featured|default_if_none:False %}
              <span class="position-absolute top-0 end-0 m-2 badge text-bg-light text-dark">
                <i class="bi bi-megaphone"></i> Publicitado
              </span>
            {% endif %}
          </div>

          <div class="p-3">
            <h3 class="h5 mb-1">{{ v.name }}</h3>
            <p class="text-soft mb-2">
              <i class="bi bi-geo"></i>
              {{ v.Commune.name }}
              {% if v.address %} ‚Ä¢ {{ v.address }}{% endif %}
            </p>

            {# Chips r√°pidos #}
            <div class="d-flex flex-wrap gap-2 mb-3">
              {% if v.experience_venue %}<span class="chip">{{ v.experience_venue|truncatechars:18 }}</span>{% endif %}
              {% if v.dress_code %}<span class="chip">{{ v.dress_code }}</span>{% endif %}
              {% if v.payment_methods %}<span class="chip">{{ v.payment_methods|truncatechars:14 }}</span>{% endif %}
            </div>

           <!-- <div class="d-flex justify-content-between align-items-center">
              <span class="small text-soft">
                <i class="bi bi-heart-fill"></i>
                {{ v.clicks_count|default:0 }} interacciones   {# cambiado: antes v.interactions #}
              </span>
              <span class="badge text-bg-success">
                <i class="bi bi-star-fill"></i>
                {{ v.rating|default:"4.5" }}
              </span>
            </div> -->
          </div>
        </article>
      </div>
    {% endfor %}
  {% else %}
    <div class="col-12">
      <div class="alert alert-secondary mb-0">
        A√∫n no hay locales publicados en {{ active_city_label }}.
      </div>
    </div>
  {% endif %}
</div>
</section>

{# ===== JS: dispara el conteo al click ===== #}
<script>
  // Toma CSRF del cookie
  function getCookie(name) {
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const csrfToken = getCookie('csrftoken');

  document.addEventListener('click', (e) => {
    const a = e.target.closest('a[data-track-model][data-track-id]');
    if (!a) return;

    const params = new URLSearchParams({
      model: a.dataset.trackModel,
      id: a.dataset.trackId,
      csrfmiddlewaretoken: csrfToken,            // üëà importante para Django
    });

    if (navigator.sendBeacon) {
      const blob = new Blob([params], { type: "application/x-www-form-urlencoded" });
      navigator.sendBeacon("{% url 'track_click' %}", blob);
    } else {
      fetch("{% url 'track_click' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": csrfToken,
          "Content-Type": "application/x-www-form-urlencoded"
        },
        body: params
      }).catch(() => {});
    }
  });
</script>



<!-- ===================== Ofertas de locales (MVP clave) ===================== -->
<section id="ofertas" class="py-5 bg-surface-1">
  <div class="container">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
      <div>
        <h2 class="section-title mb-1">Ofertas de locales</h2>
        <p class="section-sub mb-0">Orden: cercanas y con vigencia pr√≥xima.</p>
      </div>
    </div>

<div id="gridOfertas" class="row g-4">
  {% if offers_items %}
    {% for o in offers_items %}
      <div class="col-12 col-md-6 col-lg-4 o-item"
           data-dist="{{ o.dist|default:'' }}"
           data-vigencia="{{ o.vigencia_iso|default:'' }}">
        <article class="card-event h-100 position-relative">
          <a class="stretched-link text-decoration-none"
             href="{{ o.href }}"
             aria-label="{{ o.title }}"></a>

          <div class="card-cover position-relative">
            {% if o.img %}
              <img src="{{ o.img }}" alt="{{ o.title }}" loading="lazy">
            {% else %}
              {% load static %}
              <img src="{% static 'img/placeholders/venue-cover.jpg' %}"
                   alt="{{ o.title }}" loading="lazy">
            {% endif %}

            {# üîπ Aqu√≠ mostramos TODAS las promos del local #}
            {% if o.promos %}
              <div class="position-absolute top-0 start-0 m-2 d-flex flex-column gap-1">
                {% for promo in o.promos %}
                  <span class="badge badge-offer">{{ promo }}</span>
                {% endfor %}
              </div>
            {% endif %}
          </div>

          <div class="p-3">
            <h3 class="h5 mb-1">{{ o.title }}</h3>
            <p class="text-soft mb-2">
              <i class="bi bi-geo"></i> {{ o.subtitle }}
            </p>

            {# Si quieres, tambi√©n puedes listar las promos abajo #}

            {% if o.promos %}
              <ul class="small text-soft mb-3">
                {% for promo in o.promos %}
                  <li>{{ promo }}</li>
                {% endfor %}
              </ul>
            {% endif %}


            <div class="d-flex gap-2">
              <a class="btn btn-brand" href="{{ o.href }}">
                <i class="bi bi-qr-code"></i>
                <!-- Canjear -->
              </a>
              <a class="btn btn-ghost" href="{{ o.href }}">
                <i class="bi bi-upc-scan"></i>
                <!-- Mostrar en barra -->
              </a>
            </div>
          </div>
        </article>
      </div>
    {% endfor %}
  {% else %}
    <div class="col-12">
      <div class="alert alert-secondary mb-0">
        A√∫n no hay ofertas activas en {{ active_city_label }}.
      </div>
    </div>
  {% endif %}
</div>



  </div>
</section>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const grid = document.getElementById("gridOfertas");
  const select = document.getElementById("sortOfertas");

  function sortCards(mode) {
    const cards = Array.from(grid.querySelectorAll(".o-item"));
    cards.sort((a, b) => {
      if (mode === "vigencia") {
        const va = a.dataset.vigencia || "";
        const vb = b.dataset.vigencia || "";
        return va.localeCompare(vb); // ISO ordena bien por string
      } else {
        const da = parseFloat(a.dataset.dist || "9999");
        const db = parseFloat(b.dataset.dist || "9999");
        return da - db;
      }
    });
    cards.forEach(c => grid.appendChild(c));
  }

  select.addEventListener("change", e => sortCards(e.target.value));
  sortCards(select.value);
});
</script>


<!-- ===================== Bloque Locales / Organizadores ===================== -->
<section id="para-locales" class="py-5 bg-surface-1">
  <div class="container">
    <div class="bg-surface-2 rounded-lg p-4 p-md-5 shadow-1">
      <div class="row g-4 align-items-center">
        <div class="col-12 col-lg-7">
          <h2 class="section-title mb-2">Atrae m√°s p√∫blico cuando lo necesitas</h2>
          <p class="text-soft mb-3">Publica ofertas con vigencia, destaca tus eventos y mide resultados en tiempo real.</p>
          <ul class="text-soft mb-0">
            <li>Publica tu local en minutos</li>
            <li>Sube ofertas y controla cupos</li>
            <li>Destaca tu evento a la audiencia correcta</li>
          </ul>
        </div>
        <div class="col-12 col-lg-5 text-lg-end">
          <a href="{% url 'signup-company' %}" class="btn btn-brand"><i class="bi bi-building-add"></i> Crear cuenta de local</a>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ===================== SEO + Confianza 
<section id="seo-confianza" class="py-5">
  <div class="container">
    <h2 class="section-title mb-2">Salir en <span id="city-seo">La Serena</span></h2>
    <p class="section-sub">Gu√≠a breve para encontrar los mejores panoramas hoy.</p>
    <div class="row g-4">
      <div class="col-12 col-lg-8">
        <p class="text-soft">
          ¬øBuscas d√≥nde salir hoy en <b id="city-seo-inline">La Serena</b>? Aqu√≠ encuentras bares, clubs y eventos con informaci√≥n al d√≠a:
          horarios, entradas y ofertas con vigencia. Filtra por tipo de lugar o m√∫sica y guarda tus favoritos para decidir m√°s r√°pido.
        </p>
        <p class="text-soft mb-0">
          Priorizamos locales verificados y eventos con alta interacci√≥n para que tu noche tenga menos dudas y m√°s aciertos. Sin comisiones
          al usuario, y con canjes simples desde el m√≥vil en la barra.
        </p>
      </div>
      <div class="col-12 col-lg-4">
        <div class="d-flex flex-wrap gap-2">
          <span class="chip"><i class="bi bi-patch-check"></i> Locales verificados</span>
          <span class="chip"><i class="bi bi-hourglass-split"></i> Ofertas con vigencia</span>
          <span class="chip"><i class="bi bi-emoji-smile"></i> Sin comisiones al usuario</span>
        </div>
      </div>
    </div>
  </div>
</section>  ===================== -->

<!-- ===================== FAQ corto ===================== 
<section id="faq" class="py-5 bg-surface-1">
  <div class="container">
    <h2 class="section-title mb-3">Preguntas frecuentes</h2>
    <div class="accordion" id="faqCorto">
      <div class="accordion-item bg-surface-2">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fq1">
            ¬øC√≥mo funcionan las ofertas?
          </button>
        </h2>
        <div id="fq1" class="accordion-collapse collapse" data-bs-parent="#faqCorto">
          <div class="accordion-body">
            Las ofertas tienen vigencia y cupos. Toca ‚ÄúCanjear‚Äù y muestra el c√≥digo en barra antes de su vencimiento.
          </div>
        </div>
      </div>
      <div class="accordion-item bg-surface-2 mt-2">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fq2">
            ¬øCobran por usar la app?
          </button>
        </h2>
        <div id="fq2" class="accordion-collapse collapse" data-bs-parent="#faqCorto">
          <div class="accordion-body">
            No cobramos comisiones al usuario. Los locales pueden elegir planes para destacar y medir resultados.
          </div>
        </div>
      </div>
      <div class="accordion-item bg-surface-2 mt-2">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fq3">
            ¬øPuedo publicar mi evento?
          </button>
        </h2>
        <div id="fq3" class="accordion-collapse collapse" data-bs-parent="#faqCorto">
          <div class="accordion-body">
            S√≠. Crea una cuenta de organizador y sube la informaci√≥n de tu evento con fecha, venue y ticketing.
          </div>
        </div>
      </div>
    </div>
  </div>
</section>  -->

{% endblock %}

{% block extra_js %}
<script>
(() => {
  const $$ = (s,c=document)=>[...c.querySelectorAll(s)];
  const $  = (s,c=document)=>c.querySelector(s);

  // ====== TRENDING (render 4 por slide) ======
  const items = [
    {title:'Rooftop Electro', type:'evento',  tags:['rooftop','techno'], time:'Hoy 23:00', venue:'Centro', href:'/entradas/rooftop-electro', cta:'Entradas', badge:'Hoy 23:00', badgeVariant:'primary', img:'https://images.unsplash.com/photo-1532635241-17e820acc59f?q=80&w=1200&auto=format&fit=crop'},
    {title:'Bar Urbano ‚Äî 2√ó1', type:'lugar', tags:['reggaeton','2x1'],    time:'Hasta 00:00', venue:'Av. Principal', href:'#', cta:'Canjear', badge:'2√ó1', badgeVariant:'warning', img:'https://images.unsplash.com/photo-1521017432531-fbd92d05cbe6?q=80&w=1200&auto=format&fit=crop'},
    {title:'Open Mic Stand-up', type:'evento', tags:['standup','gratis'],  time:'Hoy 21:30', venue:'Teatro Centro', href:'/evento/open-mic', cta:'M√°s info', badge:'Gratis', badgeVariant:'success', img:'https://images.unsplash.com/photo-1488998527040-85054a85150e?q=80&w=1200&auto=format&fit=crop'},
    {title:'La Azotea',        type:'lugar', tags:['rooftop','2x1'],       time:'2√ó1 19‚Äì22', venue:'Mirador LS', href:'#', cta:'Canjear', badge:'Rooftop', badgeVariant:'info', img:'https://images.unsplash.com/photo-1504805572947-34fad45aed93?q=80&w=1200&auto=format&fit=crop'},
    {title:'Tech Sessions',    type:'evento', tags:['techno'],             time:'DJ invitado', venue:'Club Prisma', href:'/entradas/tech-sessions', cta:'Entradas', badge:'DJ', badgeVariant:'secondary', img:'https://images.unsplash.com/photo-1519671482749-fd09be7ccebf?q=80&w=1200&auto=format&fit=crop'},
    {title:'Flow House',       type:'lugar', tags:['reggaeton'],           time:'Nueva pista', venue:'Barrio Centro', href:'#', cta:'Guardar', badge:'Nuevo', badgeVariant:'danger', img:'https://images.unsplash.com/photo-1514525253161-7a46d19cd819?q=80&w=1200&auto=format&fit=crop'},
    {title:'Stand-up & Friends',type:'evento', tags:['standup','gratis'],  time:'Entrada gratis', venue:'Espacio Cultural', href:'/evento/standup-friends', cta:'M√°s info', badge:'Free', badgeVariant:'success', img:'https://images.unsplash.com/photo-1519751138087-5a3a3f54a3b1?q=80&w=1200&auto=format&fit=crop'},
    {title:'Sky Bar',          type:'lugar', tags:['rooftop','reggaeton'], time:'Vista 360¬∞', venue:'Costa LS', href:'#', cta:'Ver en mapa', badge:'Vista 360¬∞', badgeVariant:'info', img:'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?q=80&w=1200&auto=format&fit=crop'},
    {title:'Bassment',         type:'evento', tags:['techno'],             time:'Live set', venue:'Subsuelo BCN', href:'/entradas/bassment', cta:'Entradas', badge:'Live', badgeVariant:'dark', img:'https://images.unsplash.com/photo-1511108690759-009324a90311?q=80&w=1200&auto=format&fit=crop'}
  ];
  const $inner = $('#trendCarouselInner');
  const $indis = $('#trendIndicators');
  const perSlide = 4;

  const card = (it)=>`
    <article class="card-trend h-100">
      <div class="cover">
        <img src="${it.img}" alt="${it.title}">
        <span class="position-absolute top-0 start-0 m-2 badge badge-soft">${it.type==='evento' ? 'Evento' : 'Lugar'}</span>
        <span class="position-absolute top-0 end-0 m-2 badge text-bg-${it.badgeVariant}">${it.badge}</span>
      </div>
      <div class="body">
        <h3 class="title">${it.title}</h3>
        <p class="meta mb-3"><i class="bi bi-geo"></i> ${it.venue} ‚Ä¢ ${it.time}</p>
        <div class="d-flex gap-2">
          <a href="${it.href}" class="btn btn-sm btn-primary btn-pill">${it.cta}</a>
          <button class="btn btn-sm btn-outline-secondary btn-pill"><i class="bi bi-heart"></i></button>
        </div>
      </div>
    </article>`;

  function renderSlides(tag='all'){
    const list = items.filter(it => tag==='all' ? true : it.tags.includes(tag));
    $inner.innerHTML = ''; $indis.innerHTML = '';
    if(!list.length){
      $inner.innerHTML = `<div class="carousel-item active"><div class="grid"><div class="text-center text-secondary py-5">Sin resultados para ‚Äú${tag}‚Äù.</div></div></div>`;
      return;
    }
    for(let i=0;i<list.length;i+=perSlide){
      const group = list.slice(i,i+perSlide).map(card).join('');
      $inner.insertAdjacentHTML('beforeend', `<div class="carousel-item ${i===0?'active':''}"><div class="grid">${group}</div></div>`);
      $indis.insertAdjacentHTML('beforeend', `<button type="button" data-bs-target="#trendCarousel4" data-bs-slide-to="${i/perSlide}" ${i===0?'class="active" aria-current="true"':''} aria-label="Slide ${i/perSlide+1}"></button>`);
    }
  }
  $$('#trendChips [data-tag]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('#trendChips [data-tag]').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      renderSlides(btn.dataset.tag);
      bootstrap.Carousel.getOrCreateInstance('#trendCarousel4').to(0);
    });
  });
  const city = document.getElementById('city-current')?.textContent?.trim() || 'La Serena';
  const trendCityEl = document.getElementById('trend-city');
  if(trendCityEl) trendCityEl.textContent = city;
  renderSlides('all');

  // ====== MINI MAPA ======
  $$('#mini-map [data-map-tab]').forEach(b=>{
    b.addEventListener('click', ()=>{
      $$('#mini-map [data-map-tab]').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      $('#miniMapMode').textContent = b.dataset.mapTab.charAt(0).toUpperCase()+b.dataset.mapTab.slice(1);
    });
  });
  $('#btnAbrirMapa')?.addEventListener('click', ()=>{
    const o = $('#mapOverlayMini');
    o.innerHTML = '<div class="text-soft">Abriendo mapa completo‚Ä¶</div>';
  });

  // ====== OFERTAS (orden) ======
  const gridOf = $('#gridOfertas');
  const ofertas = $$('.o-item', gridOf);
  function sortOfertas(key){
    const items = [...ofertas];
    items.sort((a,b)=> key==='vigencia'
      ? (new Date(a.dataset.vigencia)) - (new Date(b.dataset.vigencia))
      : (+a.dataset.dist) - (+b.dataset.dist)
    );
    items.forEach(el=>gridOf.appendChild(el));
  }
  $('#sortOfertas').addEventListener('change', e=>sortOfertas(e.target.value));
  sortOfertas('cercania');

  // ====== Reveal on scroll ======
  const obs = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('in'); obs.unobserve(e.target);} });
  },{threshold:.12});
  $$('.reveal').forEach(el=>obs.observe(el));

  // ====== Chips de filtros del hero ======
  $$('.chip').forEach(ch=> ch.addEventListener('click', ()=> ch.classList.toggle('active')));

  // ====== Compartir / Favoritos demo ======
  const toastEl = document.getElementById('toast');
  if(toastEl){
    const toast = new bootstrap.Toast(toastEl);
    document.getElementById('btnFavoritos')?.addEventListener('click', ()=>{
      toastEl.querySelector('.toast-body').textContent = 'Funci√≥n de favoritos del MVP (localStorage).';
      toast.show();
    });
    document.getElementById('btnCompartir')?.addEventListener('click', async ()=>{
      const ciudad = document.getElementById('ciudad-label')?.textContent || 'tu ciudad';
      const shareData = { title:'Carreteo', text:`Mira qu√© hacer hoy en ${ciudad}`, url:location.href };
      try{ await navigator.share(shareData); } catch { await navigator.clipboard.writeText(location.href); }
      toastEl.querySelector('.toast-body').textContent = 'Enlace listo para compartir.';
      toast.show();
    });
  }
})();
</script>

<!-- ====== JSON-LD (SEO) ====== -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": "Pr√≥ximos eventos destacados en La Serena",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "url": "https://tusitio.com/evento/rooftop-electro-la-serena",
      "item": {
        "@type": "Event",
        "name": "Rooftop Electro La Serena",
        "startDate": "2025-09-20T23:00:00-03:00",
        "endDate": "2025-09-21T04:00:00-03:00",
        "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
        "eventStatus": "https://schema.org/EventScheduled",
        "location": { "@type": "Place", "name": "Centro", "address": "La Serena, Chile" },
        "image": ["https://images.unsplash.com/photo-1532635241-17e820acc59f?q=80&w=1200&auto=format&fit=crop"],
        "description": "DJ set en terraza con vista, electr√≥nica y ambiente.",
        "offers": {"@type":"Offer","availability":"https://schema.org/InStock","price":"0","priceCurrency":"CLP","url":"https://tusitio.com/evento/rooftop-electro-la-serena"}
      }
    },
    {
      "@type": "ListItem",
      "position": 2,
      "url": "https://tusitio.com/evento/comedy-beats",
      "item": {
        "@type": "Event",
        "name": "Comedy & Beats",
        "startDate": "2025-09-18T22:00:00-03:00",
        "location": { "@type":"Place","name":"Centro Cultural LS","address":"La Serena, Chile" },
        "image": ["https://images.unsplash.com/photo-1519677100203-a0e668c92439?q=80&w=1200&auto=format&fit=crop"],
        "description": "Show de comedia con m√∫sica en vivo.",
        "offers": {"@type":"Offer","price":"0","priceCurrency":"CLP","url":"https://tusitio.com/evento/comedy-beats"}
      }
    },
    {
      "@type": "ListItem",
      "position": 3,
      "url": "https://tusitio.com/evento/fiesta-prisma",
      "item": {
        "@type": "Event",
        "name": "Fiesta Prisma",
        "startDate": "2025-10-05T23:30:00-03:00",
        "location": { "@type":"Place","name":"Club Bellavista","address":"Santiago, Chile" },
        "image": ["https://images.unsplash.com/photo-1540039155733-5bb30b53aa14?q=80&w=1200&auto=format&fit=crop"],
        "description": "Noche electr√≥nica con lista y DJs invitados.",
        "offers": {"@type":"Offer","price":"0","priceCurrency":"CLP","url":"https://tusitio.com/evento/fiesta-prisma"}
      }
    }
  ]
}
</script>
<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<!-- Leaflet JS -->
<script
  defer
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js">
</script>

{% endblock %}
