{% extends "base.html" %}
{% load static %}

{% block title %}Dónde salir hoy en {{ active_city|default:"Chile" }} | Midnight{% endblock %}

{% block content %}
<article class="city-explore-page">

  <!-- ========= HERO CIUDAD / BUSCADOR ========= -->
  <header class="py-5 text-center">
    <div class="container">
      <p class="text-uppercase small text-muted mb-2">Explora la noche</p>
      <h1 class="display-4 mb-3">
        Dónde salir hoy{% if active_city %} en {{ active_city }}{% endif %}
      </h1>
      <p class="lead mb-5">
        Encuentra bares, discoteques, pubs y rooftops por ciudad. Escribe una ciudad o explora las ciudades destacadas.
      </p>

      <!-- Buscador por ciudad -->
      <form id="city-filter-form"
            class="mx-auto"
            method="get"
            action="{% url 'venue_index' %}"
            autocomplete="off"
            role="search"
            aria-label="Buscar lugares por ciudad">

        <!-- Fila 1: input grande de ciudad -->
        <div class="row justify-content-center mb-3">
          <div class="col-12 col-lg-8">
            <div class="position-relative">
              <label for="city-input" class="visually-hidden">Ciudad</label>
              <input
                id="city-input"
                class="form-control form-control-lg rounded-pill px-4 py-3"
                type="text"
                name="city"
                value="{{ city_input_value }}"
                placeholder="Escribe una ciudad (Santiago, La Serena, Coquimbo...)"
                aria-autocomplete="list"
                aria-expanded="false"
                aria-owns="city-suggestions"
                role="combobox" />

              <!-- Panel de sugerencias -->
              <div id="city-suggestions"
                  class="list-group shadow position-absolute w-100 mt-2 d-none"
                  style="max-height: 260px; overflow:auto; z-index:1050;"
                  role="listbox"
                  aria-label="Sugerencias de ciudades">
              </div>
            </div>
          </div>
        </div>

        {% if q %}
          <input type="hidden" name="q" value="{{ q }}">
        {% endif %}
      </form>
    </div>
  </header>

  <!-- ========= CONTENIDO PRINCIPAL ========= -->
  <main class="py-4 my-5" id="lugares">
    <div class="container">

      <!-- CIUDADES DESTACADAS -->
      <section class="my-5" aria-labelledby="featured-cities-heading">
        <header class="mb-3">
          <h2 id="featured-cities-heading" class="h4 mb-1">
            Ciudades destacadas
          </h2>
          <p class="text-muted mb-0">
            Explora las zonas con más movimiento nocturno y descubre sus locales y eventos.
          </p>
        </header>

        <div class="row g-3">
          {% for c in featured_cities %}
            <div class="col-6 col-md-3">
              <a href="{{ c.url }}"
                 class="text-decoration-none d-block rounded-4 overflow-hidden card-hero shadow-sm"
                 aria-label="Ver panoramas nocturnos en {{ c.name }}">
                <article class="h-100">
                  <div class="card-hero__img ratio-4x3">
                    {% if c.hero_url %}
                      <img src="{{ c.hero_url }}"
                          alt="Vista nocturna de {{ c.name }}"
                          class="w-100 h-100 object-fit-cover">
                    {% else %}
                      <img src="{% static 'img/placeholders/venue-cover.jpg' %}"
                          alt="Panoramas nocturnos en {{ c.name }}"
                          class="w-100 h-100 object-fit-cover">
                    {% endif %}
                    <div class="card-hero__overlay"></div>
                    <div class="card-hero__meta p-3">
                      <h3 class="h6 text-white mb-0">{{ c.name }}</h3>
                      <small class="text-white-50">
                        {{ c.venues_count }} lugar{% if c.venues_count|default:0 != 1 %}es{% endif %}
                      </small>
                    </div>
                  </div>
                </article>
              </a>
            </div>
          {% empty %}
            <div class="col-12">
              <p class="text-muted">
                Aún no tenemos ciudades destacadas configuradas. Prueba buscando una ciudad en el buscador superior.
              </p>
            </div>
          {% endfor %}
        </div>
      </section>

      <!-- SECCIONES DINÁMICAS (listados de lugares / destacados por ciudad) -->
      <section id="dynamic-sections"
              data-json-endpoint="{% url 'city_index_json' %}"
              aria-label="Resultados de lugares por ciudad">
        {# 
          Aquí se pueden inyectar por AJAX:
          - #featured-venues
          - #venues-grid
          u otras secciones que ya estés generando desde city_index_json.
        #}
      </section>

    </div>
  </main>

  <!-- ========= JSON EMBEBIDO PARA JS ========= -->
  <script id="city-names-json" type="application/json">
    {{ city_names_json|safe }}
  </script>
  <script id="cities-fallback-json" type="application/json">[]</script>

  <!-- ========= SCRIPTS: AUTOCOMPLETE DE CIUDADES ========= -->
  <script>
  (function() {
    const form  = document.getElementById('city-filter-form');
    const input = document.getElementById('city-input');
    const panel = document.getElementById('city-suggestions');
    if (!form || !input || !panel) return;

    function parseJSONById(id){
      try {
        const el = document.getElementById(id);
        return el && el.textContent ? JSON.parse(el.textContent) : [];
      } catch(e){
        return [];
      }
    }

    const citiesList = parseJSONById('city-names-json').length
      ? parseJSONById('city-names-json')
      : parseJSONById('cities-fallback-json');

    const norm = s => (s||'').toString()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'')
      .toLowerCase()
      .trim();

    const debounce = (fn, ms=120) => {
      let t;
      return (...a) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...a), ms);
      };
    };

    let currentIndex = -1;
    const show = () => {
      panel.classList.remove('d-none');
      input.setAttribute('aria-expanded','true');
    };
    const hide = () => {
      panel.classList.add('d-none');
      input.setAttribute('aria-expanded','false');
      currentIndex = -1;
    };

    function createItem(name, term){
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'list-group-item list-group-item-action';
      btn.setAttribute('role','option');
      btn.setAttribute('aria-label', `Buscar lugares en ${name}`);

      if (!term) {
        btn.textContent = name;
      } else {
        const n = norm(name);
        const t = norm(term);
        const i = n.indexOf(t);
        if (i < 0) {
          btn.textContent = name;
        } else {
          btn.append(document.createTextNode(name.slice(0,i)));
          const strong = document.createElement('strong');
          strong.textContent = name.slice(i, i+term.length);
          btn.append(
            strong,
            document.createTextNode(name.slice(i+term.length))
          );
        }
      }

      btn.addEventListener('click', () => {
        input.value = name;
        hide();
        form.submit();
      });
      return btn;
    }

    function rankedFilter(q){
      const t = norm(q);
      if (!t) return citiesList.slice(0,12);
      const starts = [];
      const contains = [];
      for (const c of citiesList) {
        const nc = norm(c);
        if (nc.startsWith(t)) starts.push(c);
        else if (nc.includes(t)) contains.push(c);
      }
      return [...starts, ...contains];
    }

    function render(list, term){
      panel.innerHTML = '';
      if (!list.length){
        const empty = document.createElement('div');
        empty.className = 'list-group-item text-muted';
        empty.textContent = 'Sin resultados';
        panel.append(empty);
        show();
        return;
      }
      list.slice(0,10).forEach(n => panel.append(createItem(n, term)));
      show();
    }

    const onType = debounce(v => render(rankedFilter(v), v), 120);

    input.addEventListener('input', e => onType(e.target.value));
    input.addEventListener('focus', () => onType(input.value));

    input.addEventListener('keydown', (e) => {
      const items = Array.from(panel.querySelectorAll('.list-group-item-action'));
      if (!items.length) return;

      if (e.key === 'ArrowDown'){
        e.preventDefault();
        currentIndex = (currentIndex+1) % items.length;
        items.forEach(i => i.classList.remove('active'));
        items[currentIndex].classList.add('active');
        items[currentIndex].scrollIntoView({block:'nearest'});
      } else if (e.key === 'ArrowUp'){
        e.preventDefault();
        currentIndex = (currentIndex-1+items.length) % items.length;
        items.forEach(i => i.classList.remove('active'));
        items[currentIndex].classList.add('active');
        items[currentIndex].scrollIntoView({block:'nearest'});
      } else if (e.key === 'Enter'){
        if (currentIndex >= 0){
          e.preventDefault();
          items[currentIndex].click();
        }
      } else if (e.key === 'Escape'){
        hide();
      }
    });

    document.addEventListener('click', (e) => {
      if (!panel.contains(e.target) && e.target !== input) hide();
    });
  })();
  </script>

  <!-- ========= SCRIPTS: NAV DE CATEGORÍAS (AJAX) ========= -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const nav = document.querySelector(".nav.nav-pills");
    if (!nav) return;

    nav.addEventListener("click", async e => {
      const link = e.target.closest("a[href]");
      if (!link) return;
      e.preventDefault();

      // Activa visualmente el botón
      nav.querySelectorAll(".btn-pill").forEach(b => b.classList.remove("active"));
      link.classList.add("active");

      // Muestra loading
      const featured = document.querySelector("#featured-venues");
      const grid = document.querySelector("#venues-grid");
      featured && (featured.innerHTML = "<div class='text-center p-5 text-soft'>Cargando...</div>");
      grid && (grid.innerHTML = "<div class='text-center p-5 text-soft'>Cargando...</div>");

      try {
        const url = new URL("{% url 'city_index_json' %}", window.location.origin);
        // copiar los parámetros de la URL del link
        const query = link.href.split("?")[1];
        if (query) url.search = query;

        const res = await fetch(url);
        const data = await res.json();

        if (data.featured && featured) featured.innerHTML = data.featured;
        if (data.grid && grid) grid.innerHTML = data.grid;
      } catch (err) {
        console.error(err);
        if (grid) {
          grid.innerHTML = "<div class='alert alert-danger'>Error al cargar los datos.</div>";
        }
      }
    });
  });
  </script>

  <!-- ========= SCRIPTS: MAPA (LEAFLET) ========= -->
  <script>
  (function(){
    const centerEl = document.getElementById('map-center-json');
    const venuesEl = document.getElementById('venues-map-json');
    const mapContainer = document.getElementById('map');

    if (!centerEl || !venuesEl || !mapContainer) return;

    const center = JSON.parse(centerEl.textContent || '{"lat":-33.4489,"lon":-70.6693}');
    const map = L.map('map').setView([center.lat, center.lon], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const markers = L.layerGroup().addTo(map);

    const cacheGet = k => {
      try { return JSON.parse(localStorage.getItem(k)); } catch { return null; }
    };
    const cacheSet = (k,v) => {
      try { localStorage.setItem(k, JSON.stringify(v)); } catch {}
    };
    const wait = ms => new Promise(r => setTimeout(r, ms));

    async function geocode(q){
      const url = new URL('https://nominatim.openstreetmap.org/search');
      url.searchParams.set('q', q);
      url.searchParams.set('format', 'json');
      url.searchParams.set('limit', '1');
      url.searchParams.set('countrycodes', 'cl');

      const res = await fetch(url, {
        headers: {
          'Accept-Language': 'es',
          'User-Agent': 'midnight-web/1.0 (contacto@midnight.cl)'
        }
      });
      if (!res.ok) return null;
      const data = await res.json();
      return (Array.isArray(data) && data[0])
        ? { lat: +data[0].lat, lon: +data[0].lon }
        : null;
    }

    async function paint(venues, recenter){
      markers.clearLayers();
      let first = null;

      for (let i=0; i<venues.length; i++){
        const v = venues[i];
        const key = `geo:${v.slug}`;
        let coord = cacheGet(key);

        if (!coord || coord.lat == null){
          coord = await geocode(v.q);
          cacheSet(key, coord || {lat:null, lon:null});
          await wait(1100); // ~1 req/seg: cortesía Nominatim
        }
        if (!coord || coord.lat == null) continue;
        if (!first) first = coord;

        const html = `
          <div style="min-width:220px">
            ${v.cover ? `<img src="${v.cover}" style="width:100%;height:110px;object-fit:cover;border-radius:8px;margin-bottom:6px">` : ``}
            <div class="fw-semibold">${v.name}</div>
            <div class="small text-muted">${v.category}</div>
            <div class="small">${v.address}</div>
            <a class="btn btn-sm btn-primary mt-2" href="${v.url}">Ver lugar</a>
          </div>`;

        L.marker([coord.lat, coord.lon])
          .addTo(markers)
          .bindPopup(html);
      }

      if (recenter && first) {
        map.setView([first.lat, first.lon], 13);
      }
    }

    const initialVenues = JSON.parse(venuesEl.textContent || '[]');
    paint(initialVenues, false);
  })();
  </script>

  <!-- ========= JSON-LD BÁSICO PARA ESTA PÁGINA ========= -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "name": "Dónde salir hoy en {{ active_city|default:"Chile" }}",
    "about": "Discotecas, bares, pubs, rooftops y locales nocturnos agrupados por ciudad.",
    "inLanguage": "es",
    "isPartOf": {
      "@type": "WebSite",
      "name": "Midnight"
    }
  }
  </script>

</article>
{% endblock %}
