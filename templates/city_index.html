{% extends "base.html" %}
{% load static %}

{% block title %}Carreteo — {{ active_city|default:"Todas las ciudades" }}{% endblock %}

{% block content %}
<!-- ========= HERO CIUDAD ========= -->
<!-- HERO / Buscador -->
<section class="py-5 text-center">
  <h1 class="display-1  mb-5">Adonde ir</h1>

  <form id="city-filter-form"
      class="container"
      method="get"
      action="{% url 'venue_index' %}"
      autocomplete="off">
      
  <!-- fila 1: input grande de ciudad -->
  <div class="row justify-content-center mb-3">
    <div class="col-12 col-lg-8">
      <div class="position-relative">
        <input
          id="city-input"
          class="form-control form-control-lg rounded-pill px-4 py-3"
          type="text"
          name="city"
          value="{{ city_input_value }}"
          placeholder="Escribe una ciudad"
          aria-autocomplete="list"
          aria-expanded="false"
          aria-owns="city-suggestions"
          role="combobox">
          
        <!-- panel de sugerencias -->
        <div id="city-suggestions"
             class="list-group shadow position-absolute w-100 mt-2 d-none"
             style="max-height: 260px; overflow:auto; z-index:1050;">
        </div>
      </div>
    </div>
  </div>


  {% if q %}
    <input type="hidden" name="q" value="{{ q }}">
  {% endif %}
</form>
</section>

<!-- ========= CONTENIDO ========= -->
<main class="py-4 my-5" id="lugares">
  <div class="container">
<!-- NAV DE CATEGORÍAS (preserva city, q y when automáticamente) -->

<section class="container my-5">
  <h2 class="h5 mb-3">Ciudades destacadas</h2>
  <div class="row g-3">
    {% for c in featured_cities %}
      <div class="col-6 col-md-3">
        <a href="{{ c.url }}" class="text-decoration-none card-hero shadow-sm d-block rounded-4 overflow-hidden">
          <div class="card-hero__img ratio-4x3">
            {% if c.hero_url %}
              <img src="{{ c.hero_url }}" alt="{{ c.name }}" class="w-100 h-100 object-fit-cover">
            {% else %}
              <img src="{% static 'img/placeholders/venue-cover.jpg' %}" alt="{{ c.name }}" class="w-100 h-100 object-fit-cover">
            {% endif %}
            <div class="card-hero__overlay"></div>
            <div class="card-hero__meta p-3">
              <h3 class="h6 text-white mb-0">{{ c.name }}</h3>
              <small class="text-white-50">{{ c.venues_count }} lugares</small>
            </div>
          </div>
        </a>
      </div>
    {% endfor %}
  </div>
</section>


<!-- Wrapper opcional para AJAX (si usas fetch) -->
<div id="dynamic-sections" data-json-endpoint="{% url 'city_index_json' %}">



<script id="city-names-json" type="application/json">{{ city_names_json|safe }}</script>
<script id="cities-fallback-json" type="application/json">[]</script>

<script>
(function() {
  const form  = document.getElementById('city-filter-form');
  const input = document.getElementById('city-input');
  const panel = document.getElementById('city-suggestions');
  if (!form || !input || !panel) return;

  function parseJSONById(id){
    try { const el = document.getElementById(id); return el && el.textContent ? JSON.parse(el.textContent) : []; }
    catch(e){ return []; }
  }

  const citiesList = parseJSONById('city-names-json').length ? parseJSONById('city-names-json') : parseJSONById('cities-fallback-json');

  const norm = s => (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
  const debounce = (fn, ms=120) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };

  let currentIndex = -1;
  const show = () => { panel.classList.remove('d-none'); input.setAttribute('aria-expanded','true'); };
  const hide = () => { panel.classList.add('d-none'); input.setAttribute('aria-expanded','false'); currentIndex = -1; };

  function createItem(name, term){
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'list-group-item list-group-item-action';
    btn.setAttribute('role','option');
    if (!term) btn.textContent = name;
    else {
      const n = norm(name), t = norm(term); const i = n.indexOf(t);
      if (i < 0) btn.textContent = name;
      else {
        btn.append(document.createTextNode(name.slice(0,i)));
        const strong = document.createElement('strong'); strong.textContent = name.slice(i, i+term.length);
        btn.append(strong, document.createTextNode(name.slice(i+term.length)));
      }
    }
    btn.addEventListener('click', ()=>{ input.value = name; hide(); form.submit(); });
    return btn;
  }

  function rankedFilter(q){
    const t = norm(q); if(!t) return citiesList.slice(0,12);
    const starts = [], contains = [];
    for (const c of citiesList){
      const nc = norm(c);
      if (nc.startsWith(t)) starts.push(c);
      else if (nc.includes(t)) contains.push(c);
    }
    return [...starts, ...contains];
  }

  function render(list, term){
    panel.innerHTML = '';
    if (!list.length){
      const empty = document.createElement('div'); empty.className = 'list-group-item text-muted'; empty.textContent = 'Sin resultados';
      panel.append(empty); show(); return;
    }
    list.slice(0,10).forEach(n => panel.append(createItem(n, term)));
    show();
  }

  const onType = debounce(v => render(rankedFilter(v), v), 120);
  input.addEventListener('input', e => onType(e.target.value));
  input.addEventListener('focus', () => onType(input.value));
  input.addEventListener('keydown', (e) => {
    const items = Array.from(panel.querySelectorAll('.list-group-item-action')); if (!items.length) return;
    if (e.key === 'ArrowDown'){ e.preventDefault(); currentIndex = (currentIndex+1)%items.length; items.forEach(i=>i.classList.remove('active')); items[currentIndex].classList.add('active'); items[currentIndex].scrollIntoView({block:'nearest'}); }
    else if (e.key === 'ArrowUp'){ e.preventDefault(); currentIndex = (currentIndex-1+items.length)%items.length; items.forEach(i=>i.classList.remove('active')); items[currentIndex].classList.add('active'); items[currentIndex].scrollIntoView({block:'nearest'}); }
    else if (e.key === 'Enter'){ if (currentIndex >= 0){ e.preventDefault(); items[currentIndex].click(); } }
    else if (e.key === 'Escape'){ hide(); }
  });
  document.addEventListener('click', (e)=>{ if (!panel.contains(e.target) && e.target !== input) hide(); });
})();
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const nav = document.querySelector(".nav.nav-pills");
  if (!nav) return;

  nav.addEventListener("click", async e => {
    const link = e.target.closest("a[href]");
    if (!link) return;
    e.preventDefault();

    // Activa visualmente el botón
    nav.querySelectorAll(".btn-pill").forEach(b => b.classList.remove("active"));
    link.classList.add("active");

    // Muestra loading
    const featured = document.querySelector("#featured-venues");
    const grid = document.querySelector("#venues-grid");
    featured && (featured.innerHTML = "<div class='text-center p-5 text-soft'>Cargando...</div>");
    grid && (grid.innerHTML = "<div class='text-center p-5 text-soft'>Cargando...</div>");

    try {
      const url = new URL("{% url 'city_index_json' %}", window.location.origin);
      // copiar los parámetros de la URL del link
      const query = link.href.split("?")[1];
      if (query) url.search = query;

      const res = await fetch(url);
      const data = await res.json();

      if (data.featured) featured.innerHTML = data.featured;
      if (data.grid) grid.innerHTML = data.grid;
    } catch (err) {
      console.error(err);
      grid.innerHTML = "<div class='alert alert-danger'>Error al cargar los datos.</div>";
    }
  });
});
</script>

<script>
(function(){
  const center = JSON.parse(document.getElementById('map-center-json').textContent || '{"lat":-33.4489,"lon":-70.6693}');
  const map = L.map('map').setView([center.lat, center.lon], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  const markers = L.layerGroup().addTo(map);

  const cacheGet = k => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } };
  const cacheSet = (k,v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch{} };
  const wait = ms => new Promise(r => setTimeout(r, ms));

  // ⬇️ Cambia SOLO esta función
  async function geocode(q){
    const url = new URL('https://nominatim.openstreetmap.org/search');
    url.searchParams.set('q', q);
    url.searchParams.set('format', 'json');
    url.searchParams.set('limit', '1');
    url.searchParams.set('countrycodes', 'cl');
    // Nominatim pide un User-Agent identificable
    const res = await fetch(url, {
      headers: {
        'Accept-Language': 'es',
        'User-Agent': 'midnight-web/1.0 (tu-email@dominio.com)'
      }
    });
    if (!res.ok) return null;
    const data = await res.json();
    return (Array.isArray(data) && data[0]) ? { lat: +data[0].lat, lon: +data[0].lon } : null;
  }

  async function paint(venues, recenter){
    markers.clearLayers();
    let first = null;
    for (let i=0;i<venues.length;i++){
      const v = venues[i];
      const key = `geo:${v.slug}`;
      let coord = cacheGet(key);

      if (!coord || coord.lat == null){
        coord = await geocode(v.q);
        cacheSet(key, coord || {lat:null, lon:null});
        await wait(1100); // ~1 req/seg: cortesía Nominatim
      }
      if (!coord || coord.lat == null) continue;
      if (!first) first = coord;

      const html = `
        <div style="min-width:220px">
          ${v.cover ? `<img src="${v.cover}" style="width:100%;height:110px;object-fit:cover;border-radius:8px;margin-bottom:6px">` : ``}
          <div class="fw-semibold">${v.name}</div>
          <div class="small text-muted">${v.category}</div>
          <div class="small">${v.address}</div>
          <a class="btn btn-sm btn-primary mt-2" href="${v.url}">Ver lugar</a>
        </div>`;
      L.marker([coord.lat, coord.lon]).addTo(markers).bindPopup(html);
    }
    if (recenter && first) map.setView([first.lat, first.lon], 13);
  }

  const initialVenues = JSON.parse(document.getElementById('venues-map-json').textContent || '[]');
  paint(initialVenues, false);
})();
</script>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const wrap = document.getElementById("featured-cities-container");
  if (!wrap) return;

  const needs = wrap.dataset.needsCity === "1";
  if (!needs) return; // si ya hay ciudad buscada, no cargamos destacados

  const endpoint = wrap.dataset.endpoint;
  try {
    wrap.innerHTML = "<div class='text-center p-5 text-soft'>Cargando ciudades…</div>";
    const res = await fetch(endpoint, { headers: { "X-Requested-With": "XMLHttpRequest" } });
    const data = await res.json();
    wrap.innerHTML = data.html || "";
  } catch (e) {
    console.error(e);
    wrap.innerHTML = "<div class='alert alert-danger'>No se pudieron cargar las ciudades destacadas.</div>";
  }
});
</script>



{% endblock %}

